# 在线课程平台前端开发进度

## 已完成工作

### 项目初始化与配置
- [x] 项目基础架构创建（React + TypeScript + Vite）
- [x] 安装和配置核心依赖
  - React Router DOM
  - Zustand
  - Axios
  - React Hook Form + Zod
  - Shadcn UI组件库
  - Tailwind CSS
  - 其他工具库
- [x] 路径别名配置（@/ -> src/）
- [x] ESLint和TypeScript配置
- [x] Vite代理配置（解决跨域问题）

### 目录结构设计
- [x] 创建核心目录结构
  - assets：静态资源
  - components：通用组件
  - hooks：自定义钩子
  - lib：工具函数库
  - pages：页面组件
  - services：API服务
  - stores：状态管理
  - types：类型定义

### API服务与数据类型
- [x] 定义API接口返回数据类型（ApiResponse, PageResponse等）
- [x] 定义用户、角色、权限等模型类型
- [x] 实现基于Axios的API请求工具
  - 请求拦截器（添加token）
  - 响应拦截器（处理错误、刷新token）
  - 封装GET、POST、PUT、DELETE方法
- [x] 实现认证服务（登录、注册、获取验证码等）
- [x] 优化认证请求处理，修复认证相关错误
- [x] 修复登录重定向问题，确保登录后正确跳转到仪表盘
- [x] 完善注销功能，清除令牌和Cookie
- [x] 实现邮箱验证码请求服务
  - 定义`EmailVerificationRequest`接口
  - 添加`sendEmailVerificationCode`方法
- [x] 实现用户服务(userService.ts)
  - 获取当前用户信息
  - 更新用户基本信息
  - 更新用户密码
  - 更新用户邮箱
  - 上传用户头像
- [x] 实现机构服务(institutionService.ts)
  - 机构申请提交
  - 申请状态查询
  - 获取机构注册码
  - 机构用户注册
- [x] 实现媒体服务(mediaService.ts)
  - 获取媒体列表
  - 获取媒体详情
  - 初始化分片上传
  - 完成分片上传
  - 取消上传
  - 获取媒体访问URL

### 状态管理
- [x] 实现认证状态管理（authStore）
  - 用户登录状态
  - Token管理（包括localStorage和Cookie双重存储）
  - 登录/注册/注销功能（已完善Cookie清理）
  - 添加邮箱验证码发送功能
- [x] 实现UI状态管理（uiStore）
  - 侧边栏状态
  - 主题管理（亮色/暗色/系统）
- [x] 实现机构状态管理（institutionStore）
  - 机构申请状态
  - 申请进度跟踪
  - 注册码管理

### 路由管理
- [x] 定义应用路由结构
- [x] 实现路由守卫（RequireAuth）
- [x] 实现懒加载
- [x] 添加机构相关路由
  - 机构申请页面
  - 申请状态查询页面
  - 机构用户注册页面
- [x] 添加媒体管理路由
  - 媒体列表页面
  - 媒体上传页面

### 页面开发
- [x] 布局组件
  - MainLayout：主布局（包含导航栏和侧边栏）
  - AuthLayout：认证页面布局
- [x] 认证页面
  - 登录页面（包含表单验证和验证码）
  - 注册页面（优化为两步流程：基本信息 + 邮箱验证）
  - 机构用户注册页面（包含注册码验证）
- [x] 基础页面
  - 首页
  - 404页面
- [x] 用户页面
  - [x] 个人资料页（完整实现，包含信息编辑、密码修改、邮箱更新和头像上传）
  - 设置页面（占位实现）
- [x] 管理页面（占位实现）
  - 用户管理
  - 角色管理
  - 权限管理
- [x] 机构页面
  - [x] 机构申请页面（包含表单验证和文件上传）
  - [x] 申请状态查询页面
  - [x] 机构用户注册页面（包含注册码验证）
- [x] 媒体管理页面
  - [x] 媒体列表页面（包含分类筛选和分页）
  - [x] 媒体上传功能（包含大文件分片上传）

### UI组件
- [x] 实现导航栏组件（Navbar）
- [x] 实现侧边栏组件（Sidebar）
- [x] 实现主题切换组件（ThemeSwitcher）
- [x] 实现验证码组件（Captcha）
- [x] 默认使用亮色主题
- [x] 实现机构相关组件
  - [x] 机构申请表单（InstitutionApplicationForm）
  - [x] 申请状态展示（ApplicationStatus）
  - [x] 注册码验证组件（RegisterCodeVerification）
- [x] 实现媒体相关组件
  - [x] 媒体列表组件（MediaList）
  - [x] 媒体上传组件（MediaUpload）
  - [x] 上传进度组件（UploadProgress）

### 注册流程优化
- [x] 重构注册页面为分步表单
  - 第一步：填写基本信息（用户名、密码）
  - 第二步：邮箱验证（邮箱、验证码、邮箱验证码）
- [x] 增强用户体验
  - 步骤间数据保存与传递
  - 步骤间状态保持
  - 增加返回上一步功能
  - 邮箱验证码发送倒计时
- [x] 修复API路径问题
  - 更新验证码获取接口路径
  - 调整为两步请求：先获取key再获取图片

### 个人中心功能
- [x] 获取当前用户信息
- [x] 实现个人资料页面
  - [x] 添加选项卡式界面，包含个人资料、密码修改和邮箱更新
  - [x] 实现个人基本信息表单（昵称、手机号）
  - [x] 实现密码修改表单（旧密码、新密码、确认密码）
  - [x] 实现邮箱更新表单（当前密码、新邮箱、验证码）
  - [x] 实现头像上传与裁剪功能
  - [x] 优化表单布局和用户体验
- [ ] 实现设置页面

### 机构管理功能
- [x] 实现机构申请流程
  - [x] 机构信息表单（名称、描述、联系信息等）
  - [x] Logo上传与预览
  - [x] 表单验证与提交
  - [x] 申请状态跟踪
- [x] 实现机构用户注册
  - [x] 注册码验证
  - [x] 基本信息填写
  - [x] 邮箱验证
  - [x] 注册完成处理

### 媒体管理功能
- [x] 实现媒体列表显示
  - [x] 按类型筛选（视频、音频、图片、文档、全部）
  - [x] 分页显示
  - [x] 媒体卡片展示（标题、类型、大小、状态等）
- [x] 实现媒体文件上传
  - [x] 基本文件信息填写（标题、描述）
  - [x] 文件选择和预览
  - [x] 分片上传大文件
  - [x] 上传进度显示
  - [x] 断点续传支持
- [x] 优化上传体验
  - [x] 实现文件类型自动识别
  - [x] 文件大小显示与格式化
  - [x] 上传状态实时反馈
  - [x] 上传完成后自动刷新列表

### 工具函数库完善
- [x] 实现前端缓存工具(cache.ts)
  - 支持5分钟过期时间
  - 缓存状态检查
  - 缓存清理功能
- [x] 实现问题管理工具(questionUtils.ts)
  - 问题类型文本转换
  - 问题难度文本转换
  - 问题难度样式生成
- [x] 实现导航工具(navigationUtils.ts)
  - 问题管理页面URL生成
  - 问题组创建/编辑URL生成
  - 问题组详情URL生成
- [x] 实现日期工具(date.ts)
  - 日期格式化功能
  - 时间差计算功能

### 类型定义完善
- [x] 完善API相关类型(api.ts)
  - ApiResponse接口
  - ApiError接口
  - 分页参数和结果类型
- [x] 完善问题相关类型(question.ts)
  - 问题类型枚举
  - 问题难度枚举
  - 问题创建/更新DTO
- [x] 完善课程相关类型(course.ts)
  - 课程状态枚举
  - 支付类型枚举
  - 章节访问类型枚举
- [x] 完善审核相关类型(review.ts)
  - 审核状态枚举
  - 审核类型枚举
  - 审核任务接口
- [x] 完善角色权限类型
  - 角色相关接口(Role, RoleDTO)
  - 权限相关接口(Permission, PermissionDTO)
  - 查询参数接口

### 服务层完善
- [x] 实现HTTP请求工具(http.ts)
  - axios实例配置
  - 请求/响应拦截器
  - 统一错误处理
  - 类型安全的请求方法
- [x] 实现课程服务(course.ts)
  - 课程CRUD操作
  - 课程状态管理
  - 课程预览功能
  - 支付设置管理
- [x] 实现审核服务(review-service.ts)
  - 审核任务管理
  - 课程审核流程
  - 课程结构获取
  - 审核状态更新
- [x] 实现章节服务(chapter.ts)
  - 章节CRUD操作
  - 章节顺序调整
  - 访问类型管理
  - 本地缓存机制
- [x] 实现小节服务(section.ts)
  - 小节CRUD操作
  - 小节顺序调整
  - 媒体资源管理
  - 题目组管理
  - 缓存优化

### 缓存机制优化
- [x] 实现多级缓存策略
  - 章节缓存(byId, byCourse)
  - 小节缓存(byId, byChapter)
  - 缓存过期控制
  - 缓存自动清理
- [x] 优化数据获取性能
  - 减少重复请求
  - 智能缓存更新
  - 缓存状态追踪

### UI组件完善
- [x] 实现分页组件(pagination.tsx)
  - 基础分页功能
  - 上一页/下一页
  - 页码显示
  - 省略号处理
- [x] 实现多选组件(multi-select.tsx)
  - 选项搜索功能
  - 动画效果
  - 选项限制
  - 全选/清空
  - 禁用状态
  - 兼容性处理
- [x] 实现审核专用分页(review-pagination.tsx)
- [x] 实现表单组件(form.tsx)
  - 基于React Hook Form
  - 表单字段上下文
  - 表单控件集成
  - 错误处理
  - 辅助组件(Label, Description等)
- [x] 实现对话框组件(dialog.tsx)
  - 基于Radix UI
  - 动画效果
  - 可访问性支持
  - 自定义样式
  - 子组件(Header, Footer等)

### 组件开发规范
- [x] 统一使用client组件
- [x] 采用组合式API设计
- [x] TypeScript类型支持
- [x] 样式统一使用Tailwind
- [x] 支持自定义className
- [x] 添加data-slot属性
- [x] 实现WAI-ARIA规范

## 进行中工作

### 用户管理功能
- [ ] 完善用户服务(userService.ts)
  - GET `/api/users` - 获取用户列表
  - GET `/api/users/{id}` - 获取用户详情
  - POST `/api/users` - 创建用户
  - PUT `/api/users/{id}` - 更新用户
  - DELETE `/api/users/{id}` - 删除用户
- [ ] 实现用户管理状态(userManagementStore.ts)
- [ ] 完善用户列表页面
  - 添加数据表格组件
  - 实现分页功能
  - 实现搜索筛选
- [ ] 实现用户表单组件
  - 创建用户表单
  - 编辑用户表单
  - 表单验证

### 角色与权限管理
- [ ] 创建角色服务(roleService.ts)
  - GET `/api/roles` - 获取角色列表
  - GET `/api/roles/{id}` - 获取角色详情
  - POST `/api/roles` - 创建角色
  - PUT `/api/roles/{id}` - 更新角色
  - DELETE `/api/roles/{id}` - 删除角色
  - PUT `/api/roles/{id}/permissions` - 分配权限
- [ ] 创建权限服务(permissionService.ts)
  - GET `/api/permissions` - 获取权限列表
  - GET `/api/permissions/{id}` - 获取权限详情
- [ ] 实现角色管理页面
- [ ] 实现权限管理页面

### 解决的技术问题
- [x] 实现了基于Tabs的多功能个人资料页面
- [x] 利用React Hook Form和Zod实现表单验证和提交
- [x] 实现了头像上传预览和裁剪功能（使用react-image-crop）
- [x] 添加了邮箱更新的验证码机制
- [x] 优化了表单提交和错误处理流程
- [x] 修复了表单控件非受控到受控状态切换的问题
- [x] 优化了邮箱更新的用户体验，添加了密码先验证的流程
- [x] 实现了表单提交状态管理和Loading指示
- [x] 修复了机构申请表单的文件上传问题
- [x] 优化了机构注册码验证流程
- [x] 完善了机构用户注册的角色分配
- [x] 实现了大文件分片上传功能
  - [x] 解决了S3分片上传的ETag处理问题
  - [x] 优化了分片上传的并发处理，改为顺序上传提高稳定性
  - [x] 修复了API请求中字段名大小写导致的合并失败问题
  - [x] 实现了上传进度实时显示
  - [x] 添加了详细的错误处理和日志记录

## 待开发工作
- [ ] 课程模块页面
  - 课程列表
  - 课程详情
  - 课程搜索
- [ ] 学习模块页面
  - 视频播放
  - 课程笔记
  - 进度记录
- [ ] 订单与支付模块
  - 课程购买
  - 订单管理
- [ ] 管理模块完善
  - 用户管理CRUD
  - 角色管理CRUD
  - 权限管理CRUD
  - 课程管理
  - 内容审核

## 问题与解决方案
- [x] 路由加载问题：创建了页面占位组件解决路由导入错误
- [x] 暗色背景问题：添加了主题切换器并默认使用亮色主题
- [x] 跨域问题：通过配置Vite代理解决
- [x] 验证码获取问题：修复验证码请求URL和处理方式，确保正确显示验证码图片
- [x] 验证码处理流程：优化验证码组件，确保正确使用后端生成的验证码Key
- [x] 登录会话问题：修复响应拦截器对认证请求的处理，避免误报"会话过期"
- [x] 错误处理问题：增强错误处理和日志记录，提供更明确的错误提示
- [x] 验证码路径问题：修复了验证码获取路径，改为先获取key再获取图片
- [x] 邮件发送配置问题：修复后端邮件发送配置，确保发件人地址与SMTP认证用户一致
- [x] 登录重定向问题：修复了登录后的重定向逻辑，确保正确跳转到仪表盘
- [x] Cookie处理问题：在登录时同时设置localStorage和Cookie，注销时清除所有认证数据
- [x] 用户角色判断问题：修复了侧边栏和仪表盘中的角色判断逻辑，从使用单一角色(user.role)改为正确处理角色数组(user.roles)
- [x] 用户信息获取失败问题：修复了getCurrentUser方法中的授权头处理，确保正确传递token，并增强了错误日志和容错处理
- [x] API请求工具问题：改进了请求方法的实现，添加了更好的错误处理和日志记录，确保所有请求包含正确的Content-Type和Accept头
- [x] 机构Logo上传问题：修复了文件上传组件的验证和预览功能
- [x] 注册码验证问题：优化了注册码验证的错误处理和提示
- [ ] 移动端适配：需要优化布局和响应式设计

## 注册流程与邮箱验证

### 优化后的注册流程
- **第一步：基本信息填写**
  - 用户名输入（验证长度4-20个字符）
  - 密码输入（验证长度6-20个字符）
  - 确认密码（验证与密码一致）
  - 数据暂存在组件state中
  - 点击"下一步"进入第二步

- **第二步：邮箱验证**
  - 显示已填写的用户名提示
  - 邮箱地址输入
  - 图形验证码输入与获取
  - 发送邮箱验证码按钮（带60秒倒计时）
  - 邮箱验证码输入
  - 点击"完成注册"提交所有数据
  - "返回上一步"按钮支持修改基本信息

### 机构用户注册流程
- **第一步：注册码验证**
  - 输入机构注册码
  - 验证注册码有效性
  - 显示机构基本信息
  - 点击"下一步"进入基本信息填写

- **第二步：基本信息填写**
  - 用户名输入
  - 密码输入和确认
  - 点击"下一步"进入邮箱验证

- **第三步：邮箱验证**
  - 邮箱地址输入
  - 图形验证码验证
  - 邮箱验证码验证
  - 完成注册

### 邮箱验证码处理
- 验证码发送前进行即时表单验证
- 验证码发送成功后启用倒计时，防止频繁请求
- 验证码发送成功后才允许点击"完成注册"按钮
- 使用toast提示验证码发送状态和错误信息

### 前端技术实现
- 使用zod进行强类型表单验证
- 使用React Hook Form管理表单状态和提交
- 使用shadcn/ui的Tabs组件实现分步UI
- 使用useState保存跨步骤数据
- 使用useEffect管理验证码倒计时

## 下一步具体计划（1-2周）

### 第1周：用户管理功能
1. 创建用户服务模块
   - 实现用户列表获取
   - 实现用户详情获取
   - 实现用户创建/编辑/删除
2. 实现用户管理状态库
   - 定义状态结构
   - 实现用户数据获取与更新
3. 完善用户列表页面
   - 实现数据表格
   - 实现分页和筛选
   - 添加创建/编辑/删除操作

### 第2周：角色权限管理
1. 创建角色和权限服务模块
   - 实现角色列表获取
   - 实现权限列表获取
   - 实现角色创建/编辑/删除
   - 实现角色权限分配
2. 实现角色和权限管理状态库
   - 定义状态结构
   - 实现数据获取与更新
3. 完善角色和权限管理页面
   - 实现数据表格
   - 实现角色创建/编辑表单
   - 实现权限分配界面

### 并行任务：个人中心功能
1. 获取当前用户信息
   - 在登录成功后获取用户详情
   - 在authStore中保存用户信息
2. 完善个人资料页面
   - 显示用户基本信息
   - 实现个人信息编辑功能
3. 实现设置页面
   - 界面偏好设置
   - 密码修改功能
## 服务层实现

✅ HTTP请求工具
- 基于Axios封装
- 请求/响应拦截器
- Token自动注入
- 错误统一处理
- 401状态码自动刷新Token

✅ 课程服务
- 课程CRUD接口
- 课程状态管理
- 课程分类管理
- 课程标签管理
- 课程章节管理

✅ 审核服务
- 审核任务列表
- 审核详情查看
- 审核状态更新
- 审核意见提交
- 审核历史记录

✅ 章节服务
- 章节CRUD接口
- 章节排序管理
- 章节内容管理
- 章节访问控制

✅ 小节服务
- 小节CRUD接口
- 小节排序管理
- 小节内容管理
- 小节访问控制

✅ 标签服务
- 标签CRUD接口
- 标签列表分页查询
- 热门标签获取
- 标签名称校验
- 批量获取/创建标签
- 标签缓存管理(TTL: 5分钟)
- 标签数据本地缓存

✅ 题目组服务
- 题目组CRUD接口
- 题目组列表分页查询
- 题目组详情获取
- 题目组内题目管理
- 题目排序管理
- 批量添加/移除题目
- 机构题目组管理

✅ 题目服务
- 题目CRUD接口
- 题目列表分页查询
- 题目详情获取
- 题目批量删除
- 题目引用检查
- 题目参数处理
  - 标签ID数组处理
  - 关键词统一处理
  - 可选参数处理
- 机构题目管理

✅ 分类服务
- 分类CRUD接口
- 分类列表分页查询
- 分类树结构获取
- 分类编码校验
- 分类状态管理
- 分类排序管理
- 父子分类管理
  - 根分类获取
  - 子分类获取
  - 分类树构建
- 错误处理优化
  - 详情获取返回null
  - 分类树获取返回空数组

✅ 认证服务
- 用户认证
  - 登录接口
  - 注册接口
  - 注销接口
  - 令牌刷新
- 验证码管理
  - 验证码生成
  - 验证码校验
- 用户信息
  - 当前用户获取
  - 用户信息缓存
- 错误处理
  - 详细日志记录
  - 友好错误提示
- 令牌管理
  - 令牌存储
  - 令牌自动刷新
  - 令牌过期处理
- 兼容性处理
  - 旧版API适配
  - 令牌格式转换

✅ 用户服务
- 用户管理
  - 用户CRUD接口
  - 用户列表分页
  - 用户详情获取
  - 用户状态管理
  - 用户角色分配
  - 批量删除用户
- 个人中心
  - 当前用户信息
  - 个人资料更新
  - 密码修改
  - 头像上传
  - 邮箱更新
- 数据模型
  - 个人资料更新
  - 密码修改请求
  - 邮箱验证码
  - 邮箱更新请求
  - 头像上传响应
- 错误处理
  - 详细错误日志
  - 友好错误提示
  - 静默失败处理

## 缓存机制优化

✅ 本地缓存实现
- 标签数据缓存(TTL: 5分钟)
- 缓存自动失效
- 手动清除缓存接口
- 创建/更新/删除自动清除缓存
- 请求失败时使用过期缓存 
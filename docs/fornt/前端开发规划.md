# 在线课程平台前端开发规划 (Next.js版)

## 技术栈

### 核心框架
- Next.js 15.2.1
- React 19
- TypeScript 5

### 状态管理与数据获取
- Zustand：轻量级客户端状态管理
- Axios：HTTP请求库（用于客户端组件）
- SWR/React Query：(可选) 数据获取与缓存

### UI组件
- Tailwind CSS：已配置，用于样式开发
- shadcn/ui：基于Radix UI的组件集合，按需复制使用
- Lucide React：图标库
- Framer Motion：动画库

### 表单处理
- React Hook Form：表单处理库
- Zod：TypeScript优先的模式验证库

### 工具库
- date-fns：日期处理库
- clsx：条件类名合并
- Sonner：现代化 Toast 通知

### 开发工具
- ESLint：代码规范检查
- TypeScript：静态类型检查
- Next.js开发服务器（支持Fast Refresh）

## 项目结构 (Next.js应用路由)

```
src/
├── app/                    # Next.js应用路由
│   ├── (auth)/             # 认证相关路由组
│   │   ├── login/          # 登录页面
│   │   │   └── page.tsx    
│   │   └── register/       # 注册页面
│   │       └── page.tsx
│   ├── (dashboard)/        # 需要认证的路由组
│   │   ├── layout.tsx      # 认证后的布局（侧边栏和导航栏）
│   │   ├── page.tsx        # 仪表盘首页
│   │   ├── users/          # 用户管理
│   │   ├── roles/          # 角色管理
│   │   └── permissions/    # 权限管理
│   ├── courses/            # 公开的课程路由
│   │   ├── page.tsx        # 课程列表
│   │   └── [id]/           # 动态路由-课程详情
│   │       └── page.tsx
│   ├── api/                # API路由（可选，用于简单BFF）
│   ├── layout.tsx          # 根布局
│   └── page.tsx            # 首页
├── components/             # 通用组件
│   ├── ui/                 # 基础UI组件（shadcn）
│   ├── auth/               # 认证相关组件
│   └── dashboard/          # 仪表盘相关组件
├── lib/                    # 工具函数库
│   ├── utils.ts            # 通用工具函数
│   └── constants.ts        # 常量定义
├── services/               # API服务（客户端）
│   ├── api.ts              # API基础配置
│   ├── auth.ts             # 认证服务
│   └── user.ts             # 用户服务
├── types/                  # 类型定义
│   ├── auth.ts             # 认证相关类型
│   └── user.ts             # 用户相关类型
├── stores/                 # 客户端状态管理
│   ├── auth-store.ts       # 认证状态
│   └── ui-store.ts         # UI状态
└── middleware.ts           # Next.js中间件（认证路由保护）
```

## Next.js最佳实践

### 组件设计
1. **服务器组件与客户端组件分离**
   - 默认使用服务器组件（不添加'use client'）
   - 需要交互、hooks、浏览器API的组件使用客户端组件（添加'use client'）
   - 尽可能将状态提升到叶子组件，保持大部分UI为服务器组件

2. **布局与页面**
   - 使用嵌套布局（layouts）共享UI
   - 使用路由组（route groups）组织相关路由
   - 使用loading.tsx实现加载状态
   - 使用error.tsx处理错误边界

3. **数据获取**
   - 服务器组件中直接使用async/await获取数据
   - 客户端组件使用SWR或React Query进行数据获取
   - 使用服务器操作（server actions）处理表单提交（如果适用）

### 状态管理
1. **仅在客户端组件中使用Zustand**
   - 状态管理用于用户会话、UI状态等客户端数据
   - 所有使用Zustand的组件必须标记为'use client'

2. **认证状态**
```typescript
interface AuthState {
  user: User | null;
  isAuthenticated: boolean;
  isLoading: boolean;
  error: string | null;
  login: (credentials: LoginRequest) => Promise<void>;
  register: (data: RegisterRequest) => Promise<void>;
  logout: () => Promise<void>;
  refreshToken: () => Promise<void>;
  setUser: (user: User | null) => void;
  clearError: () => void;
}
```

3. **UI状态**
```typescript
interface UIState {
  sidebarOpen: boolean;
  theme: 'light' | 'dark' | 'system';
  toggleSidebar: () => void;
  setSidebarOpen: (open: boolean) => void;
  setTheme: (theme: 'light' | 'dark' | 'system') => void;
}
```

### 路由与认证
1. **使用Next.js中间件保护路由**
   - 检查认证状态，根据需要重定向
   - 实现基于角色的访问控制

2. **路由组分离公共和受保护内容**
   - (auth)：认证相关页面
   - (dashboard)：需要认证的管理功能

## 验证码机制的详细设计

### 后端验证码流程
1. **验证码生成**:
   - 使用Kaptcha库生成验证码图片
   - 验证码文本存储在Redis中，键名格式为`captcha:{captchaKey}`
   - 设置5分钟的过期时间
   - 验证码Key通过API响应返回

2. **验证码获取流程**:
   - 前端先调用 `/api/auth/captcha/key` 获取验证码key
   - 再使用key调用 `/api/auth/captcha/image/{key}` 获取验证码图片
   - 验证码key和用户输入的验证码一起提交给后端

3. **验证码校验**:
   - 登录/注册请求中需携带`captchaKey`和`captchaCode`
   - 后端从Redis获取对应的验证码文本
   - 比较用户提交的验证码与存储的验证码（忽略大小写）
   - 验证后立即删除验证码，确保一次性使用

### 前端验证码实现
1. **验证码组件设计**:
```tsx
interface CaptchaProps {
  onCaptchaKeyChange: (captchaKey: string) => void;
}

export function Captcha({ onCaptchaKeyChange }: CaptchaProps) {
  // 验证码状态管理与获取逻辑
  // 两步获取：先获取key，再获取图片
  // 图片数据转base64显示
}
```

2. **验证码获取流程**:
   - 组件挂载时自动获取验证码
   - 先调用获取key的接口，获取验证码key
   - 再用key获取验证码图片
   - 将验证码Key传递给父组件
   - 点击验证码图片可刷新获取新验证码

3. **邮箱验证码流程**:
   - 用户填写邮箱地址和图形验证码
   - 验证通过后发送邮箱验证码
   - 邮箱验证码倒计时（60秒）防止频繁请求
   - 验证码发送成功后才允许提交注册表单

## 注册流程设计

### 分步注册流程
1. **第一步：基本信息**
   - 用户名（长度4-20字符）
   - 密码（长度6-20字符）
   - 确认密码（验证与密码一致）
   - 点击"下一步"进入第二步

2. **第二步：邮箱验证**
   - 邮箱地址输入
   - 图形验证码输入与获取
   - 发送邮箱验证码
   - 邮箱验证码输入
   - 提交完成注册

### 技术实现
1. **表单管理**
   - 使用React Hook Form管理表单状态
   - 使用Zod进行表单验证
   - 分别定义两个表单schema和表单实例

2. **状态管理**
   - 使用组件内state管理跨步骤数据
   - 最终注册时合并所有数据提交

3. **UI组件**
   - 使用Tabs组件实现分步界面
   - 使用表单组件实现数据收集
   - 表单间数据传递和状态保持

### 用户体验
1. **引导式流程**
   - 清晰的步骤指示
   - 禁用未完成前置步骤的Tab
   - 步骤间数据预览
   - 返回功能支持修改前一步内容

2. **验证与反馈**
   - 实时表单验证
   - 即时错误提示
   - 验证码发送状态与倒计时
   - 操作结果toast通知

## 功能模块规划

### 1. 认证模块
- 登录页面
- 注册页面
- 验证码获取与验证
- JWT令牌管理（存储、刷新、清除）
- 认证状态管理
- 认证中间件实现

### 2. 公共布局模块
- 根布局组件
- 不同区域特定布局
- 导航栏
- 侧边菜单
- 主题切换

### 3. 用户中心模块
- 用户信息展示
- 用户信息编辑
- 密码修改
- 个人头像上传

### 4. 课程模块
- 课程列表页
- 课程详情页
- 课程搜索与筛选
- 课程分类浏览
- 课程收藏

### 5. 学习模块
- 课程学习页面
- 视频播放器
- 课程进度记录
- 课程笔记
- 课程评价

### 6. 管理模块
- 用户管理
- 角色管理
- 权限管理
- 课程管理
- 内容审核

### 7. 订单与支付模块
- 课程购买
- 订单管理
- 支付流程
- 优惠券管理

## 路由规划 (Next.js格式)

```
/                                # 首页
/login                           # 登录
/register                        # 注册
/courses                         # 课程列表
/courses/[id]                    # 课程详情
/courses/[id]/learn              # 课程学习
/dashboard                       # 仪表盘首页
/dashboard/profile               # 个人信息
/dashboard/settings              # 个人设置
/dashboard/favorites             # 收藏课程
/dashboard/orders                # 订单记录
/dashboard/users                 # 用户管理
/dashboard/roles                 # 角色管理
/dashboard/permissions           # 权限管理
/dashboard/courses               # 课程管理
/dashboard/reviews               # 审核管理
/dashboard/statistics            # 统计数据
```

## API对接规划

### 1. 认证相关API
- **验证码API**
  - `GET /api/auth/captcha` - 获取验证码
  - 请求参数: 可选`captchaKey`
  - 响应: 验证码图片（二进制）和`Captcha-Key`响应头
  - 集成方式: 使用axios直接请求，处理二进制响应和响应头

- **注册API**
  - `POST /api/auth/register` - 用户注册
  - 请求参数: 用户名、密码、邮箱、验证码Key、验证码
  - 响应: 成功消息
  - 表单验证: 使用Zod进行客户端验证

- **登录API**
  - `POST /api/auth/login` - 用户登录
  - 请求参数: 用户名、密码、验证码Key、验证码
  - 响应: JWT令牌（accessToken、refreshToken）
  - 状态管理: 登录成功后将令牌存储在localStorage和Zustand状态中

- **其他认证API**
  - `POST /api/auth/refresh-token` - 刷新令牌
  - `POST /api/auth/logout` - 用户注销

### 2. 用户相关API
- `/api/users` - 用户列表/创建用户
- `/api/users/:id` - 用户详情/更新/删除
- `/api/users/:id/status` - 修改用户状态
- `/api/users/:id/roles` - 用户角色分配
- `/api/users/batch` - 批量处理用户

### 3. 角色权限相关API
- `/api/roles` - 角色列表/创建角色
- `/api/roles/:id` - 角色详情/更新/删除
- `/api/roles/:id/permissions` - 角色权限分配
- `/api/permissions` - 权限列表/创建权限
- `/api/permissions/:id` - 权限详情/更新/删除

### 4. 课程相关API
- `/api/courses` - 课程列表/创建课程
- `/api/courses/:id` - 课程详情/更新/删除
- `/api/courses/:id/chapters` - 课程章节
- `/api/courses/:id/resources` - 课程资源
- `/api/courses/:id/enrollments` - 课程报名

### 5. 学习相关API
- `/api/learning/progress` - 学习进度
- `/api/learning/notes` - 学习笔记
- `/api/learning/favorites` - 收藏课程

### 6. 订单相关API
- `/api/orders` - 订单列表/创建订单
- `/api/orders/:id` - 订单详情/更新
- `/api/payments` - 支付管理

## 开发计划与时间线

### 第一阶段：基础框架与认证模块
- [x] 创建Next.js项目结构
- [x] 安装核心依赖（Zustand、Axios等）
- [x] 设置Tailwind CSS和shadcn UI
- [x] 实现基础布局组件
- [x] 创建认证页面（登录/注册）
- [x] 实现JWT令牌管理
- [x] 设置路由中间件保护
- [x] 实现认证状态管理
- [x] 完成验证码组件和集成

### 第二阶段：用户与管理模块
- [ ] 实现用户服务接口
- [ ] 完成用户管理页面
- [ ] 实现角色与权限管理
- [ ] 完成用户个人资料页面
- [ ] 实现用户设置功能

### 第三阶段：课程模块
- [ ] 实现课程列表页面
- [ ] 实现课程详情页面
- [ ] 添加课程搜索与筛选功能
- [ ] 实现课程管理功能

### 第四阶段：学习与订单功能
- [ ] 实现学习进度跟踪
- [ ] 实现课程笔记功能
- [ ] 实现课程评价功能
- [ ] 实现课程购买流程
- [ ] 实现订单管理功能

### 第五阶段：优化与测试
- [ ] 性能优化
- [ ] 兼容性测试
- [ ] 用户体验优化
- [ ] 文档编写
- [ ] 部署准备

## 组件设计

### 通用UI组件
- Button
- Input
- Select
- Checkbox
- RadioGroup
- Switch
- Dialog
- Dropdown
- Tabs
- Card
- Avatar
- Badge
- Toast
- Tooltip
- Captcha (验证码组件)

### 布局组件
- RootLayout
- DashboardLayout
- AuthLayout

### 业务组件
- 用户相关：UserTable, UserForm, UserProfile
- 角色相关：RoleTable, RoleForm, PermissionSelect
- 课程相关：CourseCard, CourseList, CourseDetails
- 学习相关：VideoPlayer, ProgressBar, NoteEditor

## 开发规范

### 代码规范
- 使用ESLint确保代码质量
- 组件文件名使用Pascal Case (ButtonComponent.tsx)
- 工具函数文件名使用kebab-case (date-utils.ts)
- 每个组件一个文件，相关组件可放在同一目录下

### Next.js特定规范
- 页面组件放在app/路径下的page.tsx文件中
- 布局组件放在对应目录的layout.tsx文件中
- 路由组使用括号命名(groupName)
- 动态路由使用方括号[param]
- 客户端组件顶部添加'use client'指令

### Git工作流
- 使用feature分支开发新功能
- 使用pull request进行代码审查
- 提交信息使用语义化前缀(feat:, fix:, docs:, etc.)

## 需要注意的问题

1. **服务器组件与客户端组件区分**
   - 谨慎使用'use client'，仅在需要时添加
   - 注意数据获取模式的差异

2. **状态管理**
   - Zustand仅用于客户端状态
   - 服务器状态使用React Query或SWR管理

3. **性能优化**
   - 利用Next.js的图像优化
   - 合理使用动态导入和懒加载
   - 避免不必要的客户端渲染

4. **安全考虑**
   - 敏感操作在服务器组件或服务器操作中处理
   - 使用Next.js中间件进行认证和授权
   - 注意API路由的安全性

5. **验证码处理**
   - 正确处理验证码Key，优先使用响应头中的值
   - 加强错误处理，提供用户友好的错误提示
   - 优化验证码刷新逻辑，避免多次不必要请求

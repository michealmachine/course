# 在线课程平台下一阶段开发需求

## 当前系统状态

目前系统已经实现了以下功能：

1. **用户认证模块**
   - 用户注册（包含邮箱验证）
   - 用户登录
   - 简化的令牌刷新（只检查黑名单）
   - 用户注销

2. **邮箱验证模块**
   - 邮件服务集成
   - 验证码生成和验证
   - Redis存储验证码
   - 邮件模板支持

3. **权限管理模块**
   - 用户管理
   - 角色管理
   - 权限管理
   - 基于角色的权限控制（RBAC简化版）
   - 控制器使用`@PreAuthorize("hasRole('XXX')")`注解控制访问

4. **用户自身管理模块**
   - 获取当前用户信息
   - 更新个人资料
   - 修改密码
   - 上传头像（MinIO存储）
   - 更新邮箱（验证码验证）
   - 专用邮箱更新验证码

5. **机构管理模块**
   - 机构申请功能
     - 机构入驻申请
     - 申请状态查询
     - 申请审核功能
     - 审核结果通知
   - 机构用户注册
     - 机构注册码生成
     - 机构用户注册
     - 邮箱验证
     - 角色分配

6. **基础设施**
   - JWT认证
   - Redis缓存
   - H2测试数据库
   - 全局异常处理
   - API文档支持
   - 文件存储服务

7. **系统优化**
   - 文件存储优化：公开资源（如用户头像）使用永久URL而非预签名URL
   - 存储效率优化：头像更新时自动删除旧文件，避免存储空间浪费
   - 架构优化：严格遵循分层架构，确保Controller不直接依赖基础设施服务
   - 文件上传大小限制：配置文件上传最大大小为100MB
   - 异常处理优化：业务逻辑统一在Service层处理并转换为合适的异常
   - 测试环境优化：解决Bean冲突和依赖注入问题
   - 分片上传实现：支持大文件上传和断点续传

## 已完成内容

### 架构优化
- [x] 严格遵循分层架构
  - [x] Controller层只负责接收请求和返回响应
  - [x] Service层封装所有业务逻辑和基础设施交互
  - [x] Repository层专注于数据访问
- [x] 代码重构
  - [x] 移除Controller直接依赖基础设施服务
  - [x] 优化异常处理流程
  - [x] 优化令牌刷新机制，确保从数据库获取最新用户角色
  - [x] 完善令牌刷新相关的单元测试

## 下一阶段开发任务

根据项目进度和系统需求，下一阶段的开发任务将集中在课程管理功能和媒体资源管理上。

### 零、媒体资源管理模块（首要优先级）

✓ 实现平台核心功能中的媒体资源（特别是视频）管理，为课程内容提供基础。

#### 1. 媒体资源实体设计

**实体类设计**:
- ✓ `Media`: 媒体资源基本信息
  - ✓ 基本属性：ID、标题、描述、类型(视频/音频/文档)、大小、原始文件名
  - ✓ 存储属性：存储路径、状态(上传中/已完成/失败)
  - ✓ 关系映射：所属机构ID、上传者ID（仅作记录）
  - ✓ 时间属性：上传时间、最后访问时间

**实现步骤**:
- ✓ 创建媒体资源实体类及关联关系（明确归属于机构而非用户）
- ✓ 实现对应的Repository接口
- ✓ 设计媒体服务接口及实现类

#### 2. 独立的存储配额服务设计

**实体与服务设计**:
- ✓ `StorageQuota`: 存储配额实体
  - ✓ 基本属性：ID、配额类型(视频/文档等)、总配额大小、已使用大小
  - ✓ 关系映射：所属机构ID
  - ✓ 时间属性：创建时间、更新时间、过期时间(可选，支持临时扩容)
- ✓ `StorageQuotaService`: 独立的存储配额服务
  - ✓ 配额检查方法
  - ✓ 配额更新方法
  - ✓ 配额查询方法
  - ✓ 配额调整方法(增加/减少)

**功能设计**:
- ✓ 支持多种配额类型（视频、文档等）
- ✓ 提供配额检查的统一接口
- ✓ 支持配额使用情况查询
- ✓ 支持配额计算和更新
- ✓ 预留配额调整和临时扩容的接口

**实现步骤**:
- ✓ 创建`StorageQuota`实体类及其Repository
- ✓ 设计`StorageQuotaService`接口及其实现类
- ✓ 实现配额检查、更新和查询逻辑
- ✓ 提供配额使用情况的API接口

#### 3. 分片上传实现

**API设计**:
- ✓ `POST /api/media/initiate-upload` - 初始化分片上传
- ✓ `GET /api/media/upload-status/{id}` - 获取上传状态
- ✓ `POST /api/media/{id}/part-completed` - 通知分片完成
- ✓ `POST /api/media/{id}/complete-upload` - 完成上传
- ✓ `DELETE /api/media/{id}/cancel-upload` - 取消上传
- ✓ `POST /api/media/{id}/resume-upload` - 恢复上传（断点续传）

**实现步骤**:
- ✓ 集成S3 API实现分片上传
- ✓ 创建上传状态跟踪机制
- ✓ 实现断点续传支持
- ✓ 提供上传状态查询接口

#### 4. 视频访问策略

**API设计**:
- ✓ `GET /api/media/{id}` - 获取媒体资源元数据
- ✓ `GET /api/media/{id}/access` - 获取临时访问URL
- ✓ `GET /api/storage/quota/{institutionId}` - 获取存储配额信息
- ✓ `GET /api/storage/quota/{institutionId}/details` - 获取存储配额详细信息

**实现步骤**:
- ✓ 实现媒体资源元数据查询接口
- ✓ 实现临时URL生成逻辑
- ✓ 实现存储配额查询接口

#### 5. 实现规划

**MVP阶段（已完成）**:
- ✓ 基础媒体实体类及关联
- ✓ 独立的存储配额服务
- ✓ 基本的分片上传功能
- ✓ 媒体文件的基本访问控制

**后续扩展（未来计划）**:
- [ ] 视频转码功能（使用消息队列）
- [ ] 更细粒度的访问控制
- [ ] 流媒体支持（HLS/DASH）
- [ ] 视频元数据提取（长度、分辨率等）
- [ ] CDN集成
- [ ] 扩展配额服务支持更多资源类型和计费集成

## 前端开发规划

基于当前后端API的实现情况，前端开发应当优先实现以下功能：

### 1. 用户认证与机构管理
- 用户注册和登录界面
- 机构申请和审核流程界面
- 用户个人资料管理
- 机构用户注册和管理

### 2. 媒体资源管理（核心优先级）
- 大文件分片上传组件
  - 文件选择与预览
  - 分片上传进度展示
  - 断点续传支持
  - 上传取消功能
- 存储配额管理面板
  - 配额使用情况可视化展示
  - 各类型资源配额详情
  - 配额使用趋势图表
- 媒体库管理界面
  - 媒体资源列表与筛选
  - 媒体详情预览
  - 视频播放器集成
  - 资源管理操作（删除、重命名等）

### 3. 技术选型建议
- 前端框架：React/Vue.js
- UI组件库：Ant Design/Element UI
- 状态管理：Redux/Vuex
- 上传组件：自定义分片上传组件（基于现有API）
- 视频播放器：Video.js/Plyr/AliPlayer（支持HLS）
- 图表库：ECharts/Chart.js（用于配额展示）

### 4. 分片上传组件实现要点
- 使用File API进行文件分片
- 调用后端API获取分片上传URL
- 使用XMLHttpRequest或Fetch API上传分片
- 实现上传进度跟踪
- 支持断点续传（保存上传状态）
- 上传完成后合并分片
- 错误处理和重试机制

### 5. 前端开发优先级
1. 认证与基础UI框架搭建
2. 媒体上传组件（分片上传核心功能）
3. 配额管理面板
4. 媒体库管理界面
5. 课程管理界面（待后端API实现）

### 一、课程管理基础模块（高优先级）

实现平台的核心业务功能，包括课程的管理、分类和标签等。

#### 1. 课程基础实体设计

**实体类设计**:
- `Course`: 课程基本信息
- `Chapter`: 课程章节
- `Lesson`: 课程小节
- `Resource`: 课程资源（视频、文档等）
- `Category`: 课程分类
- `Tag`: 课程标签
- `CourseTag`: 课程与标签关联

**实现步骤**:
1. 创建上述实体类及其关联关系
2. 设计合理的字段和约束
3. 实现对应的Repository接口

#### 2. 课程分类管理API

**API设计**:
- `GET /api/categories` - 获取分类列表
- `GET /api/categories/{id}` - 获取分类详情
- `POST /api/categories` - 创建分类（管理员）
- `PUT /api/categories/{id}` - 更新分类（管理员）
- `DELETE /api/categories/{id}` - 删除分类（管理员）

**实现步骤**:
1. 创建`CategoryController`及相关DTO/VO类
2. 实现`CategoryService`及其实现类
3. 实现分类的树形结构处理逻辑

#### 3. 课程标签管理API

**API设计**:
- `GET /api/tags` - 获取标签列表
- `GET /api/tags/{id}` - 获取标签详情
- `POST /api/tags` - 创建标签（管理员）
- `PUT /api/tags/{id}` - 更新标签（管理员）
- `DELETE /api/tags/{id}` - 删除标签（管理员）

**实现步骤**:
1. 创建`TagController`及相关DTO/VO类
2. 实现`TagService`及其实现类
3. 实现标签的热门标签推荐逻辑

#### 4. 课程基础管理API

**API设计**:
- `GET /api/courses` - 获取课程列表（支持分页、筛选）
- `GET /api/courses/{id}` - 获取课程详情
- `POST /api/courses` - 创建课程（机构用户和管理员）
- `PUT /api/courses/{id}` - 更新课程（课程创建者和管理员）
- `DELETE /api/courses/{id}` - 删除课程（课程创建者和管理员）
- `GET /api/courses/{id}/chapters` - 获取课程章节
- `POST /api/courses/{id}/chapters` - 创建课程章节

**实现步骤**:
1. 创建`CourseController`及相关DTO/VO类
2. 实现`CourseService`及其实现类
3. 实现课程的搜索和筛选逻辑
4. 实现课程内容管理逻辑

### 二、内容审核功能（次高优先级）

实现课程内容审核功能，确保平台内容质量。

#### 1. 审核流程设计

**功能设计**:
- 课程内容提交审核
- 审核人员审核内容
- 审核结果通知
- 驳回原因反馈

**实现步骤**:
1. 设计审核相关实体类
2. 设计审核流程和状态机
3. 实现审核服务和API接口

#### 2. 审核管理API

**API设计**:
- `POST /api/courses/{id}/submit` - 提交课程审核
- `GET /api/reviews` - 获取待审核列表（审核人员）
- `PUT /api/reviews/{id}` - 更新审核状态（审核人员）
- `GET /api/reviews/history` - 获取审核历史记录

**实现步骤**:
1. 创建`ReviewController`及相关DTO/VO类
2. 实现`ReviewService`及其实现类
3. 实现审核流程和权限控制

## 技术实现要点

1. **安全性考虑**
   - 严格的权限控制，确保只有授权用户能创建和管理课程
   - 文件上传安全验证，防止恶意文件

2. **性能优化**
   - 课程列表和搜索的缓存策略
   - 文件资源的CDN加速策略

3. **权限控制**
   - 基于角色的课程管理权限
   - 基于机构的资源隔离

4. **数据验证**
   - 严格验证课程内容的完整性和合法性
   - 确保资源引用的有效性

## 开发优先级

1. ✓ 完成权限管理功能及测试
2. ✓ 优化JWT令牌，仅包含角色信息
3. ✓ 实现机构申请和注册功能
   - ✓ 机构申请流程
   - ✓ 机构审核流程
   - ✓ 机构用户注册
4. 实现媒体资源管理（最高优先级）
   - 媒体实体设计与管理
   - 独立的存储配额服务
   - 分片上传实现
   - 媒体访问控制
5. 完成课程基础实体设计（高优先级）
6. 实现课程分类和标签管理（高优先级）
7. 实现课程基础管理功能（高优先级）
8. 实现课程内容结构管理（中优先级）
9. 实现内容审核流程（中优先级）
10. 【未来】考虑完善基于权限的细粒度访问控制

通过以上功能的实现，可以搭建起平台的核心课程管理框架和媒体资源管理系统，为后续的用户学习、评价、订单等功能提供基础。 
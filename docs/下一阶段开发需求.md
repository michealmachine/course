# 在线课程平台下一阶段开发需求

## 当前系统状态

目前系统已经实现了以下功能：

1. **用户认证模块**
   - 用户注册（包含邮箱验证）
   - 用户登录
   - 令牌刷新
   - 用户注销

2. **邮箱验证模块**
   - 邮件服务集成
   - 验证码生成和验证
   - Redis存储验证码
   - 邮件模板支持

3. **权限管理模块**
   - 用户管理
   - 角色管理
   - 权限管理
   - 基于RBAC的权限控制

4. **基础设施**
   - JWT认证
   - Redis缓存
   - H2测试数据库
   - 全局异常处理
   - API文档支持

## 下一阶段开发任务

根据项目进度和系统需求，下一阶段的开发任务分为两大部分：**用户信息管理模块**和**课程管理基础模块**。

### 一、用户信息管理模块（最高优先级）

当前系统的用户管理功能主要面向管理员，需要增加用户自身信息管理的功能。

#### 1. 获取当前用户信息API

**API设计**:
- 请求方法: `GET`
- 接口路径: `/api/users/current`
- 权限要求: 已登录用户
- 响应内容: 当前登录用户的详细信息，包括用户基本信息、角色信息等

**实现步骤**:
1. 在`UserController`中添加获取当前用户信息的接口
2. 在`UserService`中实现获取当前用户信息的方法
3. 返回适当的用户数据视图对象(UserVO)

**响应示例**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "id": 1,
    "username": "zhangsan",
    "email": "zhangsan@example.com",
    "phone": "13812345678",
    "avatar": "https://example.com/avatars/default.png",
    "nickname": "张三",
    "status": 1,
    "createdAt": "2023-01-01T12:00:00",
    "lastLoginAt": "2023-01-01T12:00:00",
    "roles": [
      {
        "id": 1,
        "name": "普通用户",
        "code": "ROLE_USER"
      }
    ]
  }
}
```

#### 2. 更新当前用户信息API

**API设计**:
- 请求方法: `PUT`
- 接口路径: `/api/users/current`
- 权限要求: 已登录用户
- 请求参数: 用户可修改的信息字段（昵称、手机号等）
- 响应内容: 更新后的用户信息

**请求参数示例**:
```json
{
  "nickname": "新昵称",
  "phone": "13812345678",
  "email": "newemail@example.com"
}
```

**实现步骤**:
1. 创建`UserProfileDTO`类，定义用户可修改的字段
2. 在`UserController`中添加更新当前用户信息的接口
3. 在`UserService`中实现更新用户信息的方法
4. 实现数据验证逻辑（邮箱唯一性、手机号格式等）

**响应示例**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "id": 1,
    "username": "zhangsan",
    "email": "newemail@example.com",
    "phone": "13812345678",
    "avatar": "https://example.com/avatars/default.png",
    "nickname": "新昵称",
    "status": 1,
    "createdAt": "2023-01-01T12:00:00",
    "updatedAt": "2023-01-01T13:00:00",
    "lastLoginAt": "2023-01-01T12:00:00",
    "roles": [
      {
        "id": 1,
        "name": "普通用户",
        "code": "ROLE_USER"
      }
    ]
  }
}
```

#### 3. 修改密码API

**API设计**:
- 请求方法: `PUT`
- 接口路径: `/api/users/current/password`
- 权限要求: 已登录用户
- 请求参数: 旧密码、新密码、确认密码
- 响应内容: 操作成功提示

**请求参数示例**:
```json
{
  "oldPassword": "oldPassword123",
  "newPassword": "newPassword123",
  "confirmPassword": "newPassword123"
}
```

**实现步骤**:
1. 创建`ChangePasswordDTO`类，包含旧密码、新密码、确认密码字段
2. 在`UserController`中添加修改密码的接口
3. 在`UserService`中实现密码修改和验证逻辑
4. 实现密码强度检查和旧密码验证

**响应示例**:
```json
{
  "code": 200,
  "message": "密码修改成功",
  "data": null
}
```

**安全考量**:
- 验证旧密码以确保是用户本人操作
- 新密码与确认密码必须一致
- 新密码必须满足一定的强度要求（至少包含大小写字母、数字，长度至少8位等）
- 新密码不能与旧密码相同

#### 4. 上传头像API

**API设计**:
- 请求方式: `POST`
- 接口路径: `/api/users/current/avatar`
- 权限要求: 已登录用户
- 请求参数: 头像图片文件（MultipartFile）
- 响应内容: 上传成功的头像URL

**实现步骤**:
1. 使用已配置好的MinIO/S3服务处理文件上传
2. 在`UserController`中添加上传头像的接口
3. 在`UserService`中实现头像处理和存储逻辑
4. 实现文件类型检查和大小限制

**响应示例**:
```json
{
  "code": 200,
  "message": "头像上传成功",
  "data": {
    "avatarUrl": "https://minio.example.com/avatars/user1/avatar.jpg"
  }
}
```

**技术实现**:
- 使用已集成的MinIO/S3服务作为文件存储基础设施
- 采用统一的存储路径格式：`avatars/{userId}/{timestamp}_{filename}`
- 对上传的图片进行压缩和格式转换，优化存储和加载性能
- 设置文件大小限制（如最大2MB）和类型限制（仅允许jpg、png等图片格式）
- 为每个用户创建唯一的存储路径，避免文件名冲突
- 生成带有时间戳的文件名，防止缓存问题
- 根据环境配置自动选择使用MinIO或S3兼容API

#### 5. 获取当前用户权限API

**API设计**:
- 请求方法: `GET`
- 接口路径: `/api/users/current/permissions`
- 权限要求: 已登录用户
- 响应内容: 当前用户拥有的所有权限列表

**实现步骤**:
1. 在`UserController`中添加获取当前用户权限的接口
2. 在`UserService`中实现获取用户权限的方法
3. 返回权限列表，包括权限编码和名称

**响应示例**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "roles": ["ROLE_USER"],
    "permissions": [
      {
        "code": "COURSE_VIEW",
        "name": "查看课程"
      },
      {
        "code": "COMMENT_CREATE",
        "name": "创建评论"
      }
    ]
  }
}
```

### 二、课程管理基础模块

该模块是平台的核心业务功能，实现课程的基本CRUD操作和分类管理。

#### 1. 课程基础实体设计

**实体类设计**:
- `Course`: 课程基本信息
- `Chapter`: 课程章节
- `Lesson`: 课程小节
- `Resource`: 课程资源（视频、文档等）
- `Category`: 课程分类
- `Tag`: 课程标签
- `CourseTag`: 课程与标签关联

**实现步骤**:
1. 创建上述实体类及其关联关系
2. 设计合理的字段和约束
3. 实现对应的Repository接口

#### 2. 课程分类管理API

**API设计**:
- `GET /api/categories` - 获取分类列表
- `GET /api/categories/{id}` - 获取分类详情
- `POST /api/categories` - 创建分类（管理员）
- `PUT /api/categories/{id}` - 更新分类（管理员）
- `DELETE /api/categories/{id}` - 删除分类（管理员）

**实现步骤**:
1. 创建`CategoryController`及相关DTO/VO类
2. 实现`CategoryService`及其实现类
3. 实现分类的树形结构处理逻辑

#### 3. 课程标签管理API

**API设计**:
- `GET /api/tags` - 获取标签列表
- `GET /api/tags/{id}` - 获取标签详情
- `POST /api/tags` - 创建标签（管理员）
- `PUT /api/tags/{id}` - 更新标签（管理员）
- `DELETE /api/tags/{id}` - 删除标签（管理员）

**实现步骤**:
1. 创建`TagController`及相关DTO/VO类
2. 实现`TagService`及其实现类
3. 实现标签的热门标签推荐逻辑

#### 4. 课程基础管理API

**API设计**:
- `GET /api/courses` - 获取课程列表（支持分页、筛选）
- `GET /api/courses/{id}` - 获取课程详情
- `POST /api/courses` - 创建课程（机构用户和管理员）
- `PUT /api/courses/{id}` - 更新课程（课程创建者和管理员）
- `DELETE /api/courses/{id}` - 删除课程（课程创建者和管理员）
- `GET /api/courses/{id}/chapters` - 获取课程章节
- `POST /api/courses/{id}/chapters` - 创建课程章节

**实现步骤**:
1. 创建`CourseController`及相关DTO/VO类
2. 实现`CourseService`及其实现类
3. 实现课程的搜索和筛选逻辑
4. 实现课程内容管理逻辑

## 技术实现要点

1. **安全性考虑**
   - 邮箱验证确保用户身份真实性
   - 用户只能修改自己的信息
   - 敏感操作需要验证（如修改密码验证旧密码）
   - 文件上传需做安全检查

2. **性能优化**
   - 合理使用Redis缓存热点数据（验证码、课程列表、分类数据）
   - 课程列表API支持分页查询
   - 大型数据集合使用懒加载

3. **权限控制**
   - 明确区分公开API和需要权限的API
   - 课程管理API需基于角色和资源所有权做双重权限验证

4. **数据验证**
   - 所有输入数据需进行验证
   - 业务规则验证（如创建课程需要必填字段）
   - 跨服务数据一致性保证

## 开发优先级

1. 完成用户信息管理API（最高优先级）
2. 实现课程分类和标签管理（中优先级）
3. 实现课程基础管理功能（高优先级）
4. 实现课程内容结构管理（中优先级）

通过以上功能的实现，可以搭建起平台的核心框架，为后续的课程学习、评价、订单等功能提供基础。 
# 在线课程平台项目配置说明

## 环境配置

### 开发环境 (dev)
- 数据库：MySQL
- 端口：8080
- 配置文件：`application-dev.yml`
- 特点：
  - JPA自动更新表结构（ddl-auto: update）
  - SQL语句以单行形式显示
  - 详细的SQL日志记录
  - 使用163邮箱服务
  - Redis存储验证码
  - 文件上传大小限制：100MB

### 测试环境 (test)
- 数据库：H2（内存数据库）
- 端口：8081
- 配置文件：`application-test.yml`
- 特点：
  - 每次启动重新创建表（ddl-auto: create-drop）
  - H2控制台访问：http://localhost:8081/h2-console
  - SQL语句以单行形式显示
  - 详细的SQL日志记录
  - 允许Bean覆盖：`spring.main.allow-bean-definition-overriding=true`
  - Redis使用独立数据库（database=1）
  - 使用测试邮箱配置
  - 文件上传大小限制：100MB

## 测试环境特殊配置

测试环境下启用了一些特殊配置以支持测试：

```yaml
spring:
  main:
    allow-bean-definition-overriding: true  # 允许Bean覆盖，解决集成测试中的Bean冲突
```

测试环境还配置了专用的安全配置类：

```java
@TestConfiguration
@EnableWebSecurity
@Profile("test")  // 确保只在测试环境激活
public class TestSecurityConfig {
    // 提供测试环境下的安全组件
}
```

## 日志配置
```yaml
logging:
  level:
    org.hibernate.SQL: DEBUG                           # 显示SQL语句
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE   # 显示SQL参数
    com.zhangziqi: DEBUG                              # 应用日志级别
```

## JWT配置
- 访问令牌有效期：1小时
- 刷新令牌有效期：7天
- 密钥：环境相关，需要在生产环境中妥善保管

## 数据库配置

### MySQL（开发环境）
```yaml
url: jdbc:mysql://localhost:3306/online_course?useSSL=false&serverTimezone=Asia/Shanghai&characterEncoding=utf-8
username: root
password: root
```

### H2（测试环境）
```yaml
url: jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
username: sa
password: 
```

## 切换环境
1. 通过配置文件：
   ```yaml
   spring:
     profiles:
       active: dev  # 或 test
   ```

2. 通过命令行：
   ```bash
   java -jar app.jar --spring.profiles.active=dev
   ```

3. 通过环境变量：
   ```bash
   export SPRING_PROFILES_ACTIVE=dev
   ```

## 注意事项
1. 生产环境配置文件未包含在版本控制中
2. 测试环境使用H2数据库，无需额外配置
3. JWT密钥在不同环境中应该不同
4. SQL日志格式化配置已优化为单行显示
5. 测试环境下Redis使用单独的数据库，避免与开发环境冲突

## 依赖版本
- Spring Boot: 3.3.9
- Java: 17
- JWT: 0.12.5
- 其他依赖版本由Spring Boot管理

## 文件上传配置

为了支持大文件上传，系统配置了文件上传的限制参数：

```yaml
spring:
  servlet:
    multipart:
      max-file-size: 100MB  # 单个文件的最大大小
      max-request-size: 100MB  # 单个请求的最大大小（含所有文件）
```

这一配置在开发环境和测试环境中都已设置，用于确保系统能够处理较大的文件上传需求，特别是在课程资源上传等场景中。

## 文件存储配置

### MinIO配置
```yaml
minio:
  endpoint: http://localhost:9000
  access-key: minioadmin
  secret-key: minioadmin
  bucket-name: online-course
```

### AWS S3兼容API配置
```yaml
aws:
  s3:
    endpoint: http://localhost:9000
    region: us-east-1
    access-key: minioadmin
    secret-key: minioadmin
    bucket-name: online-course-s3
    path-style-access: true
```

### 开发环境文件存储配置
在开发环境中，可以使用Docker快速启动MinIO服务：
```bash
docker run -p 9000:9000 -p 9001:9001 --name minio \
  -e "MINIO_ROOT_USER=minioadmin" \
  -e "MINIO_ROOT_PASSWORD=minioadmin" \
  -v $(pwd)/minio-data:/data \
  minio/minio server /data --console-address ":9001"
```

### 测试环境文件存储配置
测试环境下通过环境变量控制是否执行集成测试：
- MINIO_ENABLED=true：启用MinIO测试
- S3_ENABLED=true：启用S3 API测试

测试中默认跳过这些需要外部依赖的测试，只在明确设置环境变量时执行。

## 邮件服务配置

### 开发环境（163邮箱）
```yaml
spring:
  mail:
    host: smtp.163.com
    username: your-email@163.com
    password: your-smtp-password
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
            required: true
```

### 测试环境（模拟邮箱）
```yaml
spring:
  mail:
    host: smtp.qq.com
    port: 587
    username: test@qq.com
    password: test-password
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
            required: true
```

## Redis配置

### 开发环境
```yaml
spring:
  data:
    redis:
      host: localhost
      port: 6379
      database: 0
      timeout: 10000
      lettuce:
        pool:
          max-active: 8
          max-wait: -1
          max-idle: 8
          min-idle: 0
```

### 测试环境
```yaml
spring:
  data:
    redis:
      host: localhost
      database: 1  # A使用独立数据库
      timeout: 10000
      lettuce:
        pool:
          max-active: 8
          max-wait: -1
          max-idle: 8
          min-idle: 0
```
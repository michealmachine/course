# 测试说明文档

## 测试策略

本项目采用分层测试策略，确保代码质量和功能稳定性。测试分为三个主要层次：单元测试、控制器测试和集成测试。

### 测试环境

- 使用H2内存数据库进行测试
- 所有测试类添加`@ActiveProfiles("test")`注解，确保使用测试环境配置
- 测试配置文件位于`src/test/resources/application-test.yml`
- 启用Bean覆盖：`spring.main.allow-bean-definition-overriding=true`

## 测试分层架构

### 1. 单元测试（Unit Tests）

**目标**：测试单个组件的功能，完全隔离于其他组件。

**配置**：
- 使用`@ExtendWith(MockitoExtension.class)`
- 通过`@Mock`模拟所有依赖
- 通过`@InjectMocks`注入被测试组件
- 不加载Spring上下文，运行效率最高

**位置**：`src/test/java/com/zhangziqi/online_course_mine/service`

**示例**：
```java
@ExtendWith(MockitoExtension.class)
@ActiveProfiles("test")
public class CaptchaServiceTest {
    @Mock
    private DefaultKaptcha captchaProducer;
    
    @InjectMocks
    private CaptchaServiceImpl captchaService;
    
    // 测试方法...
}
```

### 2. 控制器测试（Controller Tests）

**目标**：测试API的参数验证、请求处理和响应格式。

**配置**：
- 使用`@SpringBootTest`加载应用上下文
- 使用`@AutoConfigureMockMvc(addFilters = false)`禁用安全过滤器链
- 使用`@MockBean`模拟服务层组件

**位置**：`src/test/java/com/zhangziqi/online_course_mine/controller`

**示例**：
```java
@SpringBootTest
@AutoConfigureMockMvc(addFilters = false)
@ActiveProfiles("test")
public class AuthControllerTest {
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private AuthService authService;
    
    // 测试方法...
}
```

### 3. 集成测试（Integration Tests）

**目标**：测试多个组件协同工作，包括安全过滤器和服务层。

**配置**：
- 使用`@SpringBootTest`加载完整应用上下文
- 使用`@Import(TestSecurityConfig.class)`导入测试安全配置
- 结合真实组件和必要的模拟组件

**位置**：`src/test/java/com/zhangziqi/online_course_mine/integration`

**示例**：
```java
@SpringBootTest(properties = {"spring.main.allow-bean-definition-overriding=true"})
@AutoConfigureMockMvc
@ActiveProfiles("test")
@Import(TestSecurityConfig.class)
public class AuthControllerIntegrationTest {
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private AuthService authService;
    
    // 测试方法...
}
```

### 4. 文件存储测试

**目标**：测试MinIO和S3 API的功能，包括文件上传、删除、URL生成等。

**配置**：
- 使用`@SpringBootTest`加载应用上下文
- 使用`@EnabledIfEnvironmentVariable`条件注解控制测试执行
- 测试结束后清理测试文件和存储桶

### 5. 存储配额测试

**目标**：测试机构存储配额管理功能，包括配额检查、更新和查询。

**测试类**：
```java
@ExtendWith(MockitoExtension.class)
class StorageQuotaServiceTest {
    @Mock
    private StorageQuotaRepository storageQuotaRepository;
    
    @Mock
    private InstitutionRepository institutionRepository;
    
    @InjectMocks
    private StorageQuotaServiceImpl storageQuotaService;
    
    // 测试方法...
}
```

**测试场景**：
1. **配额检查测试**
   - `hasEnoughQuota_WhenInstitutionNotExists_ReturnsFalse`
   - `hasEnoughQuota_WhenQuotaNotExists_ReturnsTrue`
   - `hasEnoughQuota_WhenQuotaExpired_ReturnsFalse`
   - `hasEnoughQuota_WhenNotEnoughSpace_ReturnsFalse`
   - `hasEnoughQuota_WhenEnoughSpace_ReturnsTrue`

2. **配额更新测试**
   - `updateUsedQuota_WhenInstitutionNotExists_ThrowsException`
   - `updateUsedQuota_WhenQuotaExists_UpdatesSuccessfully`
   - `updateUsedQuota_WhenQuotaNotExists_CreatesDefaultQuota`

3. **配额查询测试**
   - `getQuotaInfo_WhenInstitutionNotExists_ThrowsException`
   - `getQuotaInfo_WhenQuotaExists_ReturnsQuotaInfo`
   - `getAllQuotas_WhenInstitutionNotExists_ThrowsException`
   - `getAllQuotas_WhenQuotasExist_ReturnsAllQuotas`

4. **配额设置测试**
   - `setQuota_WhenInstitutionNotExists_ThrowsException`
   - `setQuota_WhenSettingNewQuota_CreatesSuccessfully`

**测试要点**：
- 验证配额计算的准确性
- 测试配额更新时的并发处理
- 验证配额过期逻辑
- 测试默认配额创建
- 确保总配额同步更新

**位置**：`src/test/java/com/zhangziqi/online_course_mine/service/StorageQuotaServiceTest.java`

### JWT相关测试

#### 令牌刷新测试
1. **令牌提供者测试（JwtTokenProviderTest）**:
   - `refreshTokenShouldCreateNewAccessTokenWithUserRoles` - 测试刷新令牌时正确获取用户角色（仅提取角色，不包括详细权限）
   - `refreshTokenShouldThrowExceptionWhenUserNotFound` - 测试用户不存在时的异常处理

2. **认证服务测试（AuthServiceTest）**:
   - `refreshTokenShouldSucceedWhenTokenValid` - 测试有效令牌的刷新流程
   - `refreshTokenShouldThrowExceptionWhenTokenInvalid` - 测试无效令牌的处理
   - `refreshTokenShouldThrowExceptionWhenTokenBlacklisted` - 测试黑名单令牌的处理

3. **测试要点**:
   - 验证刷新后的令牌仅包含用户角色信息
   - 验证令牌黑名单的处理逻辑
   - 测试完整的令牌刷新流程

### 机构相关测试

#### 1. 机构申请测试
1. **InstitutionServiceTest**:
   - `applyInstitutionShouldSucceedWhenValid` - 测试有效的机构申请
   - `applyInstitutionShouldThrowExceptionWhenEmailExists` - 测试重复联系邮箱的处理
   - `getApplicationStatusShouldReturnStatusWhenExists` - 测试获取申请状态功能
   - `getInstitutionRegisterCodeShouldSucceedWhenValid` - 测试获取机构注册码

2. **InstitutionControllerTest**:
   - `testApplyInstitution` - 测试机构申请API
   - `testGetApplicationStatus` - 测试获取申请状态API

#### 2. 机构审核测试
1. **InstitutionServiceTest**:
   - `getApplicationsShouldReturnPagedResultsWithFilters` - 测试获取机构申请列表（支持分页和筛选）
   - `approveApplicationShouldSucceedWhenPending` - 测试审核通过功能
   - `rejectApplicationShouldSucceedWhenPending` - 测试审核拒绝功能
   - `getApplicationDetailShouldReturnDetailWhenExists` - 测试获取申请详情功能

2. **ReviewerInstitutionControllerTest**:
   - `testGetApplications` - 测试获取申请列表API
   - `testGetApplicationDetail` - 测试获取申请详情API
   - `testApproveApplication` - 测试审核通过API
   - `testRejectApplication` - 测试审核拒绝API

#### 3. 机构用户注册测试
1. **InstitutionAuthServiceTest**:
   - `registerWithInstitutionCodeShouldSucceedWhenValid` - 测试使用有效注册码注册机构用户
   - `registerWithInstitutionCodeShouldThrowExceptionWhenInvalidCode` - 测试无效注册码的处理
   - `registerWithInstitutionCodeShouldThrowExceptionWhenInactiveInstitution` - 测试禁用机构的处理
   - `registerWithInstitutionCodeShouldThrowExceptionWhenCodeInvalid` - 测试机构注册码不存在的处理

2. **InstitutionAuthControllerTest**:
   - `testRegisterInstitutionMember` - 测试注册机构用户API
   - `testRegisterInstitutionMemberWithInvalidCaptcha` - 测试验证码无效的情况
   - `testRegisterInstitutionMemberWithInvalidEmailCode` - 测试邮箱验证码无效的情况

## 测试配置类

项目提供了专用的测试配置类`TestSecurityConfig`，用于集成测试：

```java
@TestConfiguration
@EnableWebSecurity
@Profile("test")
public class TestSecurityConfig {
    // 提供安全相关的模拟组件...
}
```

## 测试覆盖范围

### 已完成测试

- 认证控制器（AuthController）
  - 单元测试：`AuthControllerTest`
  - 集成测试：`AuthControllerIntegrationTest`
- 用户服务（UserService）
- 认证服务（AuthService）
- 验证码服务（CaptchaService）
- 用户自身管理功能
  - 获取当前用户信息
  - 更新个人资料
  - 修改密码
  - 更新头像
  - 更新邮箱
- 权限管理功能
  - 单元测试：`PermissionControllerTest`、`PermissionServiceTest`
  - 集成测试：`PermissionControllerIntegrationTest`
- 机构管理功能
  - 单元测试：`InstitutionServiceTest`、`InstitutionAuthServiceTest`
  - 控制器测试：`InstitutionControllerTest`、`ReviewerInstitutionControllerTest`
  - 邮件通知测试：`EmailServiceTest`

### 用户自身管理测试

用户自身管理相关功能的测试分为两部分：

1. **服务层测试 (UserServiceTest)**:
   - `getCurrentUserShouldReturnUserInfoWhenUserExists` - 测试获取当前用户信息
   - `updateCurrentUserProfileShouldUpdateUserInfoWhenValid` - 测试更新个人资料
   - `updateCurrentUserProfileShouldThrowExceptionWhenPhoneExists` - 测试手机号冲突检查
   - `changePasswordShouldSucceedWhenOldPasswordCorrect` - 测试成功修改密码
   - `changePasswordShouldThrowExceptionWhenOldPasswordIncorrect` - 测试旧密码错误
   - `changePasswordShouldThrowExceptionWhenNewPasswordSameAsOld` - 测试新旧密码相同
   - `updateAvatarShouldUpdateAvatarUrlWhenUserExists` - 测试更新头像
   - `updateEmailShouldUpdateEmailWhenValid` - 测试更新邮箱
   - `updateEmailShouldThrowExceptionWhenPasswordIncorrect` - 测试密码验证失败
   - `updateEmailShouldThrowExceptionWhenEmailExists` - 测试邮箱已存在
   - `updateEmailShouldThrowExceptionWhenEmailCodeInvalid` - 测试验证码无效
   - `getBasicUserInfoShouldReturnBasicInfoWhenUserExists` - 测试获取基本信息

2. **控制器测试 (UserControllerTest)**:
   - `testGetCurrentUser` - 测试获取当前用户API
   - `testUpdateCurrentUser` - 测试更新个人信息API
   - `testChangePassword` - 测试修改密码API
   - `testChangePasswordWithMismatchConfirmation` - 测试密码确认不匹配
   - `testUpdateEmail` - 测试更新邮箱API
   - `testUploadAvatar` - 测试上传头像API
   - `testGetBasicUserInfo` - 测试获取用户基本信息API

3. **邮箱更新验证码测试**:
   - `AuthControllerTest.testSendEmailUpdateCode` - 测试发送邮箱更新验证码API
   - `AuthControllerTest.testSendEmailUpdateCodeWithInvalidCaptcha` - 测试验证码无效场景
   - `EmailServiceTest.testSendEmailUpdateCode` - 测试邮箱更新验证码发送服务
   - `AuthControllerIntegrationTest.testSendEmailUpdateCode` - 集成测试邮箱更新验证码流程
   - `AuthControllerIntegrationTest.testSendEmailUpdateCodeWithInvalidCaptcha` - 集成测试无效验证码

### 权限管理测试

权限管理相关功能的测试也分为多个部分：

1. **服务层测试 (PermissionServiceTest)**:
   - `getPermissionListShouldReturnAllPermissions` - 测试获取所有权限
   - `getPermissionByIdShouldReturnPermissionWhenExists` - 测试根据ID获取权限
   - `getPermissionByIdShouldThrowExceptionWhenNotExists` - 测试权限不存在异常
   - `createPermissionShouldReturnCreatedPermission` - 测试创建权限
   - `createPermissionShouldThrowExceptionWhenCodeExists` - 测试权限代码已存在异常
   - `updatePermissionShouldReturnUpdatedPermission` - 测试更新权限
   - `updatePermissionShouldThrowExceptionWhenNotExists` - 测试更新不存在权限异常
   - `updatePermissionShouldThrowExceptionWhenCodeExists` - 测试更新权限代码冲突异常
   - `deletePermissionShouldSucceedWhenPermissionExists` - 测试删除权限
   - `deletePermissionShouldThrowExceptionWhenPermissionNotExists` - 测试删除不存在权限异常
   - `deletePermissionShouldThrowExceptionWhenPermissionInUse` - 测试删除被引用权限异常
   - `batchDeletePermissionsShouldSucceedWhenPermissionsExist`
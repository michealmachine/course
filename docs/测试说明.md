# 测试说明文档

## 测试策略

本项目采用分层测试策略，确保代码质量和功能稳定性。测试分为三个主要层次：单元测试、控制器测试和集成测试。

### 测试环境

- 使用H2内存数据库进行测试
- 所有测试类添加`@ActiveProfiles("test")`注解，确保使用测试环境配置
- 测试配置文件位于`src/test/resources/application-test.yml`
- 启用Bean覆盖：`spring.main.allow-bean-definition-overriding=true`

## 测试分层架构

### 1. 单元测试（Unit Tests）

**目标**：测试单个组件的功能，完全隔离于其他组件。

**配置**：
- 使用`@ExtendWith(MockitoExtension.class)`
- 通过`@Mock`模拟所有依赖
- 通过`@InjectMocks`注入被测试组件
- 不加载Spring上下文，运行效率最高

**位置**：`src/test/java/com/zhangziqi/online_course_mine/service`

**示例**：
```java
@ExtendWith(MockitoExtension.class)
@ActiveProfiles("test")
public class CaptchaServiceTest {
    @Mock
    private DefaultKaptcha captchaProducer;
    
    @InjectMocks
    private CaptchaServiceImpl captchaService;
    
    // 测试方法...
}
```

### 2. 控制器测试（Controller Tests）

**目标**：测试API的参数验证、请求处理和响应格式。

**配置**：
- 使用`@SpringBootTest`加载应用上下文
- 使用`@AutoConfigureMockMvc(addFilters = false)`禁用安全过滤器链
- 使用`@MockBean`模拟服务层组件

**位置**：`src/test/java/com/zhangziqi/online_course_mine/controller`

**示例**：
```java
@SpringBootTest
@AutoConfigureMockMvc(addFilters = false)
@ActiveProfiles("test")
public class AuthControllerTest {
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private AuthService authService;
    
    // 测试方法...
}
```

### 3. 集成测试（Integration Tests）

**目标**：测试多个组件协同工作，包括安全过滤器和服务层。

**配置**：
- 使用`@SpringBootTest`加载完整应用上下文
- 使用`@Import(TestSecurityConfig.class)`导入测试安全配置
- 结合真实组件和必要的模拟组件

**位置**：`src/test/java/com/zhangziqi/online_course_mine/integration`

**示例**：
```java
@SpringBootTest(properties = {"spring.main.allow-bean-definition-overriding=true"})
@AutoConfigureMockMvc
@ActiveProfiles("test")
@Import(TestSecurityConfig.class)
public class AuthControllerIntegrationTest {
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private AuthService authService;
    
    // 测试方法...
}
```

### 4. 文件存储测试

**目标**：测试MinIO和S3 API的功能，包括文件上传、删除、URL生成等。

**配置**：
- 使用`@SpringBootTest`加载应用上下文
- 使用`@EnabledIfEnvironmentVariable`条件注解控制测试执行
- 测试结束后清理测试文件和存储桶

**位置**：`src/test/java/com/zhangziqi/online_course_mine/integration`

**示例**：
```java
@SpringBootTest
@ActiveProfiles("test")
class MinioIntegrationTest {
    @Autowired
    private MinioService minioService;
    
    @Test
    @EnabledIfEnvironmentVariable(named = "MINIO_ENABLED", matches = "true")
    void testMinioOperations() throws Exception {
        // 测试文件上传、获取URL、删除等操作
    }
    
    @Test
    void testSkippedByDefault() {
        // 默认跳过的测试
    }
}
```

```java
@SpringBootTest
@ActiveProfiles("test")
class S3IntegrationTest {
    @Autowired
    private S3Client s3Client;
    
    @Autowired
    private S3Presigner s3Presigner;
    
    @Autowired
    private S3Config s3Config;
    
    @Test
    @EnabledIfEnvironmentVariable(named = "S3_ENABLED", matches = "true")
    void testS3Operations() {
        // 测试S3操作，包括创建存储桶、上传对象、生成预签名URL等
    }
    
    private void createBucketIfNotExists() {
        // 检查并创建测试存储桶
    }
    
    @Test
    void testSkippedByDefault() {
        // 默认跳过的测试
    }
}
```

## 测试配置类

项目提供了专用的测试配置类`TestSecurityConfig`，用于集成测试：

```java
@TestConfiguration
@EnableWebSecurity
@Profile("test")
public class TestSecurityConfig {
    // 提供安全相关的模拟组件...
}
```

## 测试覆盖范围

### 已完成测试

- 认证控制器（AuthController）
  - 单元测试：`AuthControllerTest`
  - 集成测试：`AuthControllerIntegrationTest`
- 用户服务（UserService）
- 认证服务（AuthService）
- 验证码服务（CaptchaService）
- 用户自身管理功能
  - 获取当前用户信息
  - 更新个人资料
  - 修改密码
  - 更新头像
  - 更新邮箱

### 用户自身管理测试

用户自身管理相关功能的测试分为两部分：

1. **服务层测试 (UserServiceTest)**:
   - `getCurrentUserShouldReturnUserInfoWhenUserExists` - 测试获取当前用户信息
   - `updateCurrentUserProfileShouldUpdateUserInfoWhenValid` - 测试更新个人资料
   - `updateCurrentUserProfileShouldThrowExceptionWhenPhoneExists` - 测试手机号冲突检查
   - `changePasswordShouldSucceedWhenOldPasswordCorrect` - 测试成功修改密码
   - `changePasswordShouldThrowExceptionWhenOldPasswordIncorrect` - 测试旧密码错误
   - `changePasswordShouldThrowExceptionWhenNewPasswordSameAsOld` - 测试新旧密码相同
   - `updateAvatarShouldUpdateAvatarUrlWhenUserExists` - 测试更新头像
   - `updateEmailShouldUpdateEmailWhenValid` - 测试更新邮箱
   - `updateEmailShouldThrowExceptionWhenPasswordIncorrect` - 测试密码验证失败
   - `updateEmailShouldThrowExceptionWhenEmailExists` - 测试邮箱已存在
   - `updateEmailShouldThrowExceptionWhenEmailCodeInvalid` - 测试验证码无效
   - `getBasicUserInfoShouldReturnBasicInfoWhenUserExists` - 测试获取基本信息

2. **控制器测试 (UserControllerTest)**:
   - `testGetCurrentUser` - 测试获取当前用户API
   - `testUpdateCurrentUser` - 测试更新个人信息API
   - `testChangePassword` - 测试修改密码API
   - `testChangePasswordWithMismatchConfirmation` - 测试密码确认不匹配
   - `testUpdateEmail` - 测试更新邮箱API
   - `testUploadAvatar` - 测试上传头像API
   - `testGetBasicUserInfo` - 测试获取用户基本信息API

3. **邮箱更新验证码测试**:
   - `AuthControllerTest.testSendEmailUpdateCode` - 测试发送邮箱更新验证码API
   - `AuthControllerTest.testSendEmailUpdateCodeWithInvalidCaptcha` - 测试验证码无效场景
   - `EmailServiceTest.testSendEmailUpdateCode` - 测试邮箱更新验证码发送服务
   - `AuthControllerIntegrationTest.testSendEmailUpdateCode` - 集成测试邮箱更新验证码流程
   - `AuthControllerIntegrationTest.testSendEmailUpdateCodeWithInvalidCaptcha` - 集成测试无效验证码

### 待完成测试

- JWT相关组件测试
- Repository层测试
- 工具类测试

## 测试命令

```bash
# 运行所有测试
./mvnw test

# 运行特定测试类
./mvnw test -Dtest=AuthControllerTest

# 运行特定测试方法
./mvnw test -Dtest=AuthControllerTest#testLogin
```

## 最佳实践

1. **分层策略**：根据测试目标选择合适的测试层次
   - 单元测试：业务逻辑验证
   - 控制器测试：API接口验证
   - 集成测试：组件协作验证

2. **模拟依赖**：
   - 单元测试中模拟所有外部依赖
   - 控制器测试中模拟业务服务
   - 集成测试中仅模拟必要组件

3. **测试隔离**：
   - 使用独立的测试数据库（H2内存数据库）
   - 使用独立的Redis数据库（database=1）
   - 测试完成后自动清理数据

4. **覆盖率目标**：
   - 服务层：≥ 90%
   - 控制器层：≥ 80%
   - 工具类：≥ 95%

5. **测试设计原则**：
   - 每个测试方法只测试一个功能点
   - 测试名称清晰描述测试场景和预期结果
   - 遵循"准备-执行-验证"模式
   - 独立性：测试之间不应相互依赖 
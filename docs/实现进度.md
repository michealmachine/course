# 在线课程平台实现进度

## 已完成内容

### 基础设施
- [x] 项目结构设计
- [x] 多环境配置（dev, test）
- [x] H2数据库集成（用于测试）
- [x] Redis缓存集成
- [x] 全局异常处理
- [x] 统一响应格式
- [x] OpenAPI文档支持
- [x] 验证码功能
- [x] 邮箱验证功能
  - [x] 邮件服务集成
  - [x] 验证码生成和验证
  - [x] Redis存储验证码
  - [x] 邮件模板支持
- [x] 文件存储集成
  - [x] MinIO对象存储服务集成
  - [x] AWS S3兼容API集成
  - [x] 文件上传、下载、删除功能
  - [x] 公开资源使用永久URL，私有资源使用预签名URL
  - [x] 文件资源自动清理（头像更新时删除旧文件）
  - [x] 文件上传大小限制优化（最大100MB）

### 架构优化
- [x] 严格遵循分层架构
  - [x] Controller层只负责接收请求和返回响应
  - [x] Service层封装所有业务逻辑和基础设施交互
  - [x] Repository层专注于数据访问
- [x] 代码重构
  - [x] 移除Controller直接依赖基础设施服务
  - [x] 优化异常处理流程

### 实体类设计
- [x] 基础实体类（BaseEntity）
- [x] 用户实体（User）
- [x] 角色实体（Role）
- [x] 权限实体（Permission）
- [x] 机构实体（Institution）
- [x] 角色枚举（RoleEnum）

### 数据访问层
- [x] 用户Repository
- [x] 角色Repository
- [x] 权限Repository
- [x] 机构Repository

### 安全框架
- [x] Spring Security配置
- [x] JWT令牌配置
- [x] JWT令牌提供者
  - [x] 优化令牌内容，仅包含角色信息，减小令牌体积
  - [x] 刷新令牌机制优化（仅验证黑名单）
  - [x] 完善令牌刷新的单元测试
- [x] JWT认证过滤器
- [x] Token黑名单服务（基于Redis）

### 认证授权
- [x] 用户详情服务
- [x] 认证服务
- [x] 用户服务
- [x] 注册接口
- [x] 登录接口
- [x] 刷新令牌接口
- [x] 注销接口
- [x] 数据初始化（角色、权限）
- [x] 基于角色的访问控制（@PreAuthorize）

### 权限管理
- [x] 用户管理接口
- [x] 角色管理接口
- [x] 权限管理接口

### 用户自身管理
- [x] 获取当前用户信息
- [x] 更新个人资料
- [x] 修改密码
- [x] 更新头像（MinIO存储）
- [x] 更新邮箱（验证码验证）
- [x] 获取用户基本信息
- [x] 邮箱更新专用验证码

### 机构管理
- [x] 机构申请功能
  - [x] 机构入驻申请
  - [x] 申请状态查询
  - [x] 申请审核功能
  - [x] 审核结果通知
- [x] 机构用户注册
  - [x] 机构注册码生成
  - [x] 机构用户注册
  - [x] 邮箱验证
  - [x] 角色分配

## 待完成内容

### 业务功能
- [ ] 课程管理
- [ ] 内容审核
- [ ] 用户学习
- [ ] 评价系统
- [ ] 订单支付

## 测试计划
- [x] 测试环境配置
  - [x] H2内存数据库
  - [x] 测试专用配置文件
  - [x] Bean冲突解决方案
- [x] 单元测试
  - [x] 服务层测试
    - [x] 用户服务测试
    - [x] 认证服务测试
    - [x] 验证码服务测试
    - [x] 邮件服务测试
    - [x] 用户自身管理功能测试
    - [x] 权限服务测试
    - [x] 角色服务测试
    - [x] 机构服务测试
  - [ ] 工具类测试
- [x] 控制器测试
  - [x] 认证控制器测试
    - [x] 图形验证码测试
    - [x] 邮箱验证码测试
    - [x] 注册登录测试
    - [x] 邮箱更新验证码测试
  - [x] 用户控制器测试
    - [x] 用户管理测试
    - [x] 用户自身管理测试
  - [x] 权限管理测试
    - [x] 权限控制器测试
    - [x] 角色控制器测试
  - [x] 机构管理测试
    - [x] 机构申请控制器测试
    - [x] 机构审核控制器测试
    - [x] 机构用户注册测试
- [x] 集成测试
  - [x] 认证控制器集成测试
    - [x] 完整注册流程测试
    - [x] 邮箱验证失败测试
    - [x] 邮箱更新验证码测试
  - [x] 权限管理集成测试
    - [x] 权限控制器集成测试
    - [x] 角色控制器集成测试
    - [x] 权限管理授权测试
  - [x] 机构管理集成测试
    - [x] 机构申请流程测试
    - [x] 机构审核流程测试
    - [x] 机构用户注册流程测试
  - [ ] Repository测试
  - [ ] 端到端测试

## 下一步计划
1. ✓ 完善用户管理功能
2. ✓ 实现角色管理功能
3. ✓ 实现权限管理功能
4. ✓ 实现用户自身管理功能
5. ✓ 完善权限管理接口的测试
6. ✓ 完善角色管理接口的测试
7. ✓ 实现机构申请和注册功能
   - ✓ 机构申请流程
   - ✓ 机构审核流程
   - ✓ 机构用户注册
8. 开始课程管理相关功能
   - 设计课程相关实体类（课程、章节、课时等）
   - 实现课程Repository层
   - 实现课程Service层
   - 实现课程Controller层
9. 设计和实现课程内容审核功能

## 已实现API接口

### 认证管理
- `GET /api/auth/captcha/key` - 获取验证码key
- `GET /api/auth/captcha/image/{key}` - 获取验证码图片
- `POST /api/auth/email-verification-code` - 发送邮箱验证码（用于注册）
- `POST /api/auth/email-update-code` - 发送邮箱更新验证码（用于更新邮箱）
- `POST /api/auth/register` - 用户注册（包含邮箱验证）
- `POST /api/auth/login` - 用户登录
- `POST /api/auth/refresh-token` - 刷新令牌
- `POST /api/auth/logout` - 用户注销

### 用户管理
- `GET /api/users` - 分页查询用户列表
- `GET /api/users/{id}` - 获取用户详情
- `POST /api/users` - 创建用户
- `PUT /api/users/{id}` - 更新用户
- `DELETE /api/users/{id}` - 删除用户
- `PATCH /api/users/{id}/status` - 修改用户状态
- `PUT /api/users/{id}/roles` - 给用户分配角色
- `DELETE /api/users/batch` - 批量删除用户

### 用户自身管理
- `GET /api/users/current` - 获取当前用户信息
- `PUT /api/users/current` - 更新当前用户信息
- `PUT /api/users/current/password` - 修改当前用户密码
- `PUT /api/users/current/email` - 更新当前用户邮箱
- `POST /api/users/current/avatar` - 上传/更新当前用户头像
- `GET /api/users/basic/{userId}` - 获取用户基本信息

### 角色管理
- `GET /api/roles` - 获取角色列表
- `GET /api/roles/{id}` - 获取角色详情
- `POST /api/roles` - 创建角色
- `PUT /api/roles/{id}` - 更新角色
- `DELETE /api/roles/{id}` - 删除角色
- `PUT /api/roles/{id}/permissions` - 给角色分配权限
- `DELETE /api/roles/batch` - 批量删除角色

### 权限管理
- `GET /api/permissions` - 获取权限列表
- `GET /api/permissions/{id}` - 获取权限详情
- `POST /api/permissions` - 创建权限
- `PUT /api/permissions/{id}` - 更新权限
- `DELETE /api/permissions/{id}` - 删除权限
- `DELETE /api/permissions/batch` - 批量删除权限

### 机构管理
- `POST /api/institutions/apply` - 申请创建机构
- `GET /api/institutions/application-status` - 查询申请状态
- `GET /api/reviewer/institutions/applications` - 获取机构申请列表（审核员）
- `GET /api/reviewer/institutions/applications/{id}` - 获取申请详情（审核员）
- `POST /api/reviewer/institutions/applications/{id}/approve` - 审核通过（审核员）
- `POST /api/reviewer/institutions/applications/{id}/reject` - 审核拒绝（审核员）
- `POST /api/auth/institution/register` - 机构用户注册
- `GET /api/institutions/members/register-code` - 获取机构注册码

## 技术栈

- Spring Boot 3.3.9
- Spring Security
- Spring Data JPA
- Spring Data Redis
- JWT (JSON Web Token)
- Kaptcha (验证码)
- Thymeleaf (邮件模板)
- MinIO/S3 (文件存储)
- OpenAPI/Swagger文档
- JUnit 5 (单元测试)
- Mockito (模拟测试)
- H2 Database (测试环境)
- MySQL (开发环境) 